---
image: gitpod/workspace-full

additionalRepositories:
  - url: https://github.com/esthesis-iot/esthesis-device
  - url: https://github.com/esthesis-iot/esthesis-docs
  - url: https://github.com/esthesis-iot/esthesis-docker

workspaceLocation:
  esthesis-platform/.code-workspace

vscode:
  extensions:
    - ms-azuretools.vscode-docker
    - Pivotal.vscode-boot-dev-pack
    - redhat.vscode-xml
    - pivotal.vscode-spring-boot
    - asciidoctor.asciidoctor-vscode
    - vscjava.vscode-java-pack
    - GabrielBB.vscode-lombok

tasks:
  - name: Preparing env
    init: |
      docker compose -f /workspace/esthesis-platform/docker-compose.yml -f /workspace/esthesis-platform/docker-compose-devenv.yml pull esthesis-db esthesis-mqtt esthesis-tsdb esthesis-nifi esthesis-chronograf
      yes | sdk install java 17.0.2-tem
      cd /workspace/esthesis-platform/esthesis-server
      mvn clean install -DskipTests=true
      cd /workspace/esthesis-platform/esthesis-ui
      npm install
      cd /workspace/esthesis-device/java
      mvn de.qaware.maven:go-offline-maven-plugin:resolve-dependencies
    command: gp sync-done env

  - name: Supporting containers  
    command: |
      gp sync-await env
      docker compose -f /workspace/esthesis-platform/docker-compose.yml -f /workspace/esthesis-platform/docker-compose-devenv.yml up -d esthesis-db esthesis-mqtt esthesis-tsdb esthesis-nifi esthesis-chronograf
      gp sync-done docker
      docker compose -f /workspace/esthesis-platform/docker-compose.yml -f /workspace/esthesis-platform/docker-compose-devenv.yml logs -f

  - name: Backend
    command: |
      gp sync-await docker
      yes | sdk install java 17.0.2-tem
      cd /workspace/esthesis-platform/esthesis-server/esthesis-server-impl
      export esthesis_fsRoot=/workspace/.esthesis/platform
      mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -XX:+ShowCodeDetailsInExceptionMessages -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=55000" -Dspring-boot.run.arguments="--server.port=46000"

  - name: Frontend
    command: |
      gp sync-await docker
      cd /workspace/esthesis-platform/esthesis-ui
      npx -y @angular/cli serve --host 0.0.0.0 --disable-host-check --proxy-config proxy.conf.json

ports:
  - port: 3306
    name: MariaDB
    onOpen: ignore
  - port: 4200
    name: Angular UI
    onOpen: open-preview
  - port: 8086
    onOpen: ignore
  - port: 8080
    name: NiFi UI
    onOpen: ignore
  - port: 1883
    name: MQTT
    onOpen: ignore
  - port: 8883
    name: MQTT/s
    onOpen: ignore
  - port: 8888
    name: Chronograf
    onOpen: ignore
