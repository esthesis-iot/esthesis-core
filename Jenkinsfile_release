pipeline{
    agent {
        docker {
            image 'eddevopsd2/ubuntu-dind:dind-mvn3.6.3-jdk15-npm6.14.13-buildx-helm'
            args '--privileged -v /root/.m2/Esthesis:/root/.m2'
        }
    }
    options {
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    stages{
        stage ("Prompt for Input") {
            steps {
                script {
                    env.RELEASE_VERSION = input message: 'Release version:',
                                     parameters: [string(defaultValue: '',
                                                  description: 'Attention: To avoid Git conflicts, please do not push to esthesis-iot git repositories or build esthesis-device release job before this one finishes.',
                                                  name: 'Release version')]
                    env.NEXT_DEV_VERSION = input message: 'Snapshot version:',
                                     parameters: [string(defaultValue: '',
                                                  description: '',
                                                  name: 'Next development version')]
                }
            }
        }
        stage ("Clone projects") {
            steps{
                withCredentials([usernamePassword(credentialsId: 'Jenkins Github token',
                usernameVariable: 'Username',
                passwordVariable: 'Password')]){
                    sh '''
                        git config --global user.email "devops-d2@eurodyn.com"
                        git config --global user.name "$Username"
                        git clone https://$Username:$Password@github.com/esthesis-iot/esthesis-server.git
                        git clone https://$Username:$Password@github.com/esthesis-iot/esthesis-setup.git
                        git clone https://$Username:$Password@github.com/esthesis-iot/esthesis-ui.git
                        git clone https://$Username:$Password@github.com/esthesis-iot/esthesis-docs.git
                    '''
                }
            }
        }
        stage ("esthesis-server: Push changes for RELEASE version"){
            steps{
                withCredentials([usernamePassword(credentialsId: 'Jenkins Github token',
                usernameVariable: 'Username',
                passwordVariable: 'Password')]){
                    sh '''
                        git remote set-url origin https://$Username:$Password@github.com/esthesis-iot/esthesis-server.git
                        cd esthesis-server
                        mvn versions:set -DnewVersion=$RELEASE_VERSION
                        mvn versions:commit
                        mvn clean install
                        git commit -a -m "release: prepare release $RELEASE_VERSION"
                        git tag -a $RELEASE_VERSION -m "$RELEASE_VERSION"
                        git push https://$Username:$Password@github.com/esthesis-iot/esthesis-server HEAD:master --tags
                        cd ..
                    '''
                }                
            }
        }
        stage ("esthesis-server: Build & Push Docker image"){
            environment {
		            DOCKERHUB_CREDENTIALS=credentials('devops_d2_dockerhub')
	                }
            steps{
                    sh '''
                        echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                        cd esthesis-setup
                        sed -i "s|esthesisiot/esthesis-server:.*$|esthesisiot/esthesis-server:$RELEASE_VERSION|" docker/docker-compose.yml
                        docker compose -f docker/docker-compose.yml build esthesis-server
                        docker push esthesisiot/esthesis-server:$RELEASE_VERSION
                        cd ..
                    '''               
            }   
        }
        stage ("esthesis-ui: Push changes for RELEASE version"){
            steps{
                withCredentials([usernamePassword(credentialsId: 'Jenkins Github token',
                usernameVariable: 'Username',
                passwordVariable: 'Password')]){
                    sh '''
                        git remote set-url origin https://$Username:$Password@github.com/esthesis-iot/esthesis-ui.git
                        cd esthesis-ui
                        sed -i 's|\"version\":.*$|\"version\": \"'$RELEASE_VERSION'\",|' package.json
                        npm install
                        npx ng build --configuration production --output-path=dist
                        git commit -a -m "release: prepare release $RELEASE_VERSION"
                        git tag -a $RELEASE_VERSION -m "$RELEASE_VERSION"
                        git push https://$Username:$Password@github.com/esthesis-iot/esthesis-ui HEAD:main --tags
                        cd ..
                    '''
                }                
            }
        }
        stage ("esthesis-ui: Build & Push Docker Image"){     
            environment {
		            DOCKERHUB_CREDENTIALS=credentials('devops_d2_dockerhub')
	                }
            steps{
                    sh '''
                        echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                        cd esthesis-setup/docker
                        sed -i "s|esthesisiot/esthesis-ui:.*$|esthesisiot/esthesis-ui:$RELEASE_VERSION|" docker-compose.yml
                        docker compose build esthesis-ui
                        docker push esthesisiot/esthesis-ui:$RELEASE_VERSION
                        cd ../..
                    '''               
            }   
        }
        stage ("Helm Package for RELEASE version"){
            steps{
                withCredentials([usernamePassword(credentialsId: 'Jenkins Github token',
                usernameVariable: 'Username',
                passwordVariable: 'Password')]){
                    sh '''#!/bin/bash
                        cd esthesis-setup/k8s/helm/esthesis-platform
                        find . -name Chart.yaml | xargs sed -i "s|version:.*$|version: $RELEASE_VERSION|"
                        cd charts
                        find . -name *.yaml | xargs sed -i "s|esthesisiot/esthesis-ui:.*$|esthesisiot/esthesis-ui:$RELEASE_VERSION|"
                        find . -name *.yaml | xargs sed -i "s|esthesisiot/esthesis-server:.*$|esthesisiot/esthesis-server:$RELEASE_VERSION|"
                        find . -name *.yaml | xargs sed -i "s|esthesisiot/esthesis-nifi:.*$|esthesisiot/esthesis-nifi:$RELEASE_VERSION|"
                        git remote set-url origin https://$Username:$Password@github.com/esthesis-iot/esthesis-setup.git
                        git commit -a -m "update esthesis-platform helm charts and docker-compose.yml to release version: $RELEASE_VERSION"
                        git push https://$Username:$Password@github.com/esthesis-iot/esthesis-setup HEAD:master
                        cd ../..
                        pushd . && \
                        helm package esthesis-platform -d ../../../esthesis-docs/helm && \
                        cd ../../../esthesis-docs/helm && \
                        helm repo index . && \
                        popd
                        cd ../../..
                        cd esthesis-docs
                        git remote set-url origin https://$Username:$Password@github.com/esthesis-iot/esthesis-docs.git
                        git add .
                        git commit -m "package esthesis-platform charts for release version: $RELEASE_VERSION"
                        git push https://$Username:$Password@github.com/esthesis-iot/esthesis-docs HEAD:master
                        cd ..
                    '''
                }                
            }   
        }  
        stage ("esthesis-server: Push changes for next development version"){
            steps{
                withCredentials([usernamePassword(credentialsId: 'Jenkins Github token',
                usernameVariable: 'Username',
                passwordVariable: 'Password')]){
                    sh '''
                        cd esthesis-server
                        mvn versions:set -DnewVersion=$NEXT_DEV_VERSION
                        mvn versions:commit
                        git commit -a -m "release: prepare for next development iteration"
                        git push https://$Username:$Password@github.com/esthesis-iot/esthesis-server HEAD:master
                        cd ..

                        cd esthesis-setup/docker
                        sed -i "s|esthesisiot/esthesis-server:.*$|esthesisiot/esthesis-server:$NEXT_DEV_VERSION|" docker-compose.yml
                        cd ../..
                    '''
                }                
            }             
        }
        stage ("esthesis-ui: Push changes for next development version"){
            steps{
                withCredentials([usernamePassword(credentialsId: 'Jenkins Github token',
                usernameVariable: 'Username',
                passwordVariable: 'Password')]){
                    sh '''
                        cd esthesis-ui
                        sed -i 's|\"version\":.*$|\"version\": \"'$NEXT_DEV_VERSION'\",|' package.json
                        git commit -a -m "release: prepare for next development iteration"
                        git push https://$Username:$Password@github.com/esthesis-iot/esthesis-ui HEAD:main
                        cd ..

                        cd esthesis-setup/docker
                        sed -i "s|esthesisiot/esthesis-ui:.*$|esthesisiot/esthesis-ui:$NEXT_DEV_VERSION|" docker-compose.yml
                        cd ../..
                    '''
                }                
            }             
        }  
        stage ("Helm Charts for next development version"){
            steps{
                withCredentials([usernamePassword(credentialsId: 'Jenkins Github token',
                usernameVariable: 'Username',
                passwordVariable: 'Password')]){
                    sh '''
                        cd esthesis-setup/k8s/helm/esthesis-platform
                        find . -name Chart.yaml | xargs sed -i "s|version:.*$|version: $NEXT_DEV_VERSION|"
                        cd charts
                        find . -name *.yaml | xargs sed -i "s|esthesisiot/esthesis-ui:.*$|esthesisiot/esthesis-ui:$NEXT_DEV_VERSION|"
                        find . -name *.yaml | xargs sed -i "s|esthesisiot/esthesis-server:.*$|esthesisiot/esthesis-server:$NEXT_DEV_VERSION|"
                        find . -name *.yaml | xargs sed -i "s|esthesisiot/esthesis-nifi:.*$|esthesisiot/esthesis-nifi:$NEXT_DEV_VERSION|"
                        git remote set-url origin https://$Username:$Password@github.com/esthesis-iot/esthesis-setup.git
                        git commit -a -m "update esthesis-platform helm charts and docker-compose.yaml for next development version: $NEXT_DEV_VERSION"
                        git push https://$Username:$Password@github.com/esthesis-iot/esthesis-setup HEAD:master
                    '''
                }                
            }   
        }  
    }
}
